name: Translate Files

on:
  push:
    branches:
      - main
    paths:
      - '**.html'

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install OpenAI
        run: pip install openai

      - name: Translate HTML files
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          import os
          import glob
          import openai
          
          # Set up OpenAI client
          client = openai.OpenAI(api_key=os.environ["OPENAI_API_KEY"])
          
          # Find all HTML files
          html_files = glob.glob("**/*.html", recursive=True)
          
          for file_path in html_files:
              print(f"Translating {file_path}...")
              
              # Read the HTML file
              with open(file_path, "r", encoding="utf-8") as f:
                  content = f.read()
              
              # Translate with OpenAI
              response = client.chat.completions.create(
                  model="gpt-4",
                  messages=[
                      {"role": "system", "content": "You are a translator specializing in software development. Preserve HTML markup and technical terms. Only translate the text content to Spanish."},
                      {"role": "user", "content": f"Translate this HTML to Spanish, preserving all HTML tags:\n\n{content}"}
                  ]
              )
              
              translated_content = response.choices[0].message.content
              
              # Create output directory
              os.makedirs(f"translations/es/{os.path.dirname(file_path)}", exist_ok=True)
              
              # Save translated file
              output_path = f"translations/es/{file_path}"
              with open(output_path, "w", encoding="utf-8") as f:
                  f.write(translated_content)
              
              print(f"Saved to {output_path}")
        shell: python

      - name: Upload Translations
        uses: actions/upload-artifact@v3
        with:
          name: spanish-translations
          path: translations
