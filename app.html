<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Contact Finder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #1A77F0;
            --secondary-color: #192B47;
            --light-bg: #EAF1FF;
            --white: #ffffff;
            --success: #AAF0D1;
            --warning: #FFCC99;
            --danger: #FF9999;
            --gray: #ccc;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        /* Authentication styles */
.auth-container {
    max-width: 500px;
    margin: 0 auto 30px;
    background-color: var(--light-bg);
    border-radius: 10px;
    padding: 25px;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.auth-form h2 {
    text-align: center;
    margin-bottom: 20px;
    color: var(--secondary-color);
}

.auth-footer {
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
    color: var(--secondary-color);
}

.auth-footer a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 600;
}

.auth-footer a:hover {
    text-decoration: underline;
}

.user-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 10px 15px;
    background-color: var(--light-bg);
    border-radius: 8px;
}

.user-email {
    font-weight: 600;
    color: var(--secondary-color);
}

.logout-button {
    background-color: transparent;
    color: var(--secondary-color);
    border: 1px solid var(--secondary-color);
    border-radius: 5px;
    padding: 5px 10px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.logout-button:hover {
    background-color: var(--secondary-color);
    color: var(--white);
}
        
        body {
            background-color: var(--white);
            color: var(--secondary-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--light-bg);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .search-section {
            background-color: var(--light-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .search-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--secondary-color);
        }
        
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .form-group {
            flex: 1 1 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--gray);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .search-button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 28px;
            width: 100%;
        }
        
        .search-button:hover {
            background-color: #1666C1;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-count {
            font-size: 18px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .export-button {
            background-color: var(--white);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-button:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .results-table th {
            background-color: var(--light-bg);
            color: var(--primary-color);
            text-align: left;
            padding: 15px;
            font-weight: bold;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .results-table td {
            padding: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .results-table tr:last-child td {
            border-bottom: none;
        }
        
        .results-table tr:hover {
            background-color: var(--light-bg);
            cursor: pointer;
        }
        
        .action-icons {
            display: flex;
            gap: 10px;
        }
        
        .action-icons i {
            color: var(--gray);
            cursor: pointer;
            font-size: 18px;
            transition: color 0.3s;
        }
        
        .action-icons i:hover {
            color: var(--primary-color);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading i {
            color: var(--primary-color);
            font-size: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .contact-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            position: relative;
            background-color: var(--white);
            margin: 50px auto;
            padding: 30px;
            width: 80%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 28px;
            color: var(--gray);
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
        }
        
        .modal-header {
            margin-bottom: 25px;
            border-bottom: 1px solid var(--light-bg);
            padding-bottom: 15px;
        }
        
        .modal-title {
            font-size: 24px;
            color: var(--secondary-color);
        }
        
        .modal-body {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .contact-info, .company-info {
            flex: 1 1 300px;
        }
        
        .info-section-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .info-item {
            margin-bottom: 15px;
        }
        
        .info-label {
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        .info-value {
            color: var(--secondary-color);
        }
        
        .info-tag {
            display: inline-block;
            background-color: var(--light-bg);
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* Alert styles */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .alert-success {
            background-color: rgba(170, 240, 209, 0.3);
            border: 1px solid var(--success);
            color: #2a6;
        }
        
        .alert-error {
            background-color: rgba(255, 153, 153, 0.3);
            border: 1px solid var(--danger);
            color: #d33;
        }
        
        .alert-warning {
            background-color: rgba(255, 204, 153, 0.3);
            border: 1px solid var(--warning);
            color: #c73;
        }
        
        .no-results {
            text-align: center;
            padding: 40px 0;
            color: var(--gray);
            font-size: 18px;
            display: none;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 10px;
        }
        
        .pagination button {
            background-color: var(--white);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination button.active {
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        .pagination button:hover:not(.active) {
            background-color: var(--light-bg);
        }
        
        .pagination button:disabled {
            border-color: var(--gray);
            color: var(--gray);
            cursor: not-allowed;
        }
        
        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 14px;
            color: var(--secondary-color);
        }
        
        .pagination-info {
            font-style: italic;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .page-size-selector select {
            padding: 5px;
            border: 1px solid var(--gray);
            border-radius: 4px;
            background-color: var(--white);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .form-group {
                flex: 1 1 100%;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 15px;
            }
            
            .results-table {
                font-size: 14px;
            }
            
            .results-table th, .results-table td {
                padding: 10px;
            }
            
            .results-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Business Contact Finder</div>
        </header>

        <div id="authContainer" class="auth-container">
    <div id="loginForm" class="auth-form">
        <h2>Login to Access Business Contacts</h2>
        <div id="authAlert" class="alert"></div>
        <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" placeholder="Your password" required>
        </div>
        <button id="loginButton" class="search-button">
            <i class="fas fa-sign-in-alt"></i> Login
        </button>
        <div class="auth-footer">
            Don't have an account? <a href="#" id="showRegisterLink">Register</a>
        </div>
    </div>
    
    <div id="registerForm" class="auth-form hidden">
        <h2>Create an Account</h2>
        <div id="registerAlert" class="alert"></div>
        <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
            <label for="registerPassword">Password</label>
            <input type="password" id="registerPassword" placeholder="Create a secure password" required>
        </div>
        <button id="registerButton" class="search-button">
            <i class="fas fa-user-plus"></i> Register
        </button>
        <div class="auth-footer">
            Already have an account? <a href="#" id="showLoginLink">Login</a>
        </div>
    </div>
</div>

<div id="userInfo" class="user-info hidden">
    <div class="user-email"><i class="fas fa-user-circle"></i> <span id="userEmailDisplay"></span></div>
    <button id="logoutButton" class="logout-button">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>
        
        <section class="search-section">
            <h2 class="search-title">Find Business Contacts</h2>
            
            <div id="searchAlert" class="alert"></div>
            
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label for="country">Country</label>
                    <select id="country" name="country">
                        <option value="">All Countries</option>
                        <!-- Country options will be populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="industry">Industry</label>
                    <select id="industry" name="industry">
                        <option value="">All Industries</option>
                        <!-- Industry options will be populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
    <div class="form-group">
    <label for="managementLevel">Management Level</label>
    <select id="managementLevel" name="managementLevel">
        <option value="">All Levels</option>
        <option value="Owner">Owner</option>
        <option value="C_suite">C_suite</option>
        <option value="Founder">Founder</option>
        <option value="Director">Director</option>
        <option value="Head">Head</option>
        <option value="Manager">Manager</option>
        <option value="Partner">Partner</option>
        <option value="Senior">Senior</option>
        <option value="Entry">Entry</option>
    </select>
</div>
                
                <div class="form-group">
                    <label for="companyName">Company Name</label>
                    <input type="text" id="companyName" name="companyName" placeholder="e.g. Acme Inc">
                </div>
                
                <div class="form-group">
                    <label for="keywords">Keywords</label>
                    <input type="text" id="keywords" name="keywords" placeholder="e.g. SaaS, B2B">
                </div>
                
                <div class="form-group">
                    <button type="submit" class="search-button">
                        <i class="fas fa-search"></i> Search Contacts
                    </button>
                </div>
            </form>
        </section>
        
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Searching for contacts...</p>
        </div>
        
        <section id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <div class="results-count">Found <span id="resultsNumber">0</span> contacts</div>
                <button id="exportButton" class="export-button">
                    <i class="fas fa-download"></i> Export to CSV
                </button>
            </div>
            
            <div id="noResults" class="no-results">
                <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px;"></i>
                <p>No contacts found. Try adjusting your search criteria.</p>
            </div>
            
            <table id="resultsTable" class="results-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Title</th>
                        <th>Company</th>
                        <th>Email</th>
                        <th>Country</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
            
            <div id="resultsInfo" class="results-info">
                <div class="pagination-info">
                    Showing <span id="startRecord">0</span>-<span id="endRecord">0</span> of <span id="totalDisplayRecords">0</span> contacts 
                </div>
            </div>
        </section>
    </div>
    
    <div id="contactModal" class="contact-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            
            <div class="modal-header">
                <h2 class="modal-title" id="modalName">Contact Details</h2>
            </div>
            
            <div class="modal-body">
                <div class="contact-info">
                    <h3 class="info-section-title">Contact Information</h3>
                    
                    <div class="info-item">
                        <div class="info-label">Full Name</div>
                        <div class="info-value" id="modalFullName"></div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Job Title</div>
                        <div class="info-value" id="modalTitle"></div>
                    </div>
                    

                    <div class="info-item">
                        <div class="info-label">Management Level</div>
                        <div class="info-value" id="modalManagementLevel"></div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value" id="modalEmail"></div>
                    </div>

                    <div class="info-item">
                         <div class="info-label">Phone</div>
                       <div class="info-value" id="modalPhone"></div>
                    </div>
                    
                    
                    <div class="info-item">
                        <div class="info-label">LinkedIn</div>
                        <div class="info-value" id="modalLinkedIn"></div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Location</div>
                        <div class="info-value" id="modalLocation"></div>
                    </div>
                </div>
                
                <div class="company-info">
                    <h3 class="info-section-title">Company Information</h3>
                    
                    <div class="info-item">
                        <div class="info-label">Company</div>
                        <div class="info-value" id="modalCompany"></div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Industry</div>
                        <div class="info-value" id="modalIndustry"></div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Company Size</div>
                        <div class="info-value" id="modalCompanySize"></div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Website</div>
                        <div class="info-value" id="modalWebsite"></div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Company Phone</div>
                        <div class="info-value" id="modalCompanyPhone"></div>
                    </div>
                
                    <div class="info-item">
                        <div class="info-label">Description</div>
                        <div class="info-value" id="modalDescription"></div>
                    </div>
                 
                </div>
            </div>
        </div>
    </div>

   <div id="exportModal" class="contact-modal">
    <div class="modal-content">
        <span class="close-export-modal">&times;</span>
        
        <div class="modal-header">
            <h2 class="modal-title">Export Contacts</h2>
        </div>
        
        <div class="modal-body">
            <div class="info-item">
                <div class="info-value">
                   <p>Are you sure you want to export this list of leads? This will use credits from your account. Your verified contact list will be sent to your <strong>email</strong> within 3 hours.</p>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="exportLimit"><strong>Number of leads to export:</strong></label>
                <input type="number" id="exportLimit" name="exportLimit" value="1000" min="1" max="5000" style="width: 100%; padding: 10px; border: 2px solid var(--gray); border-radius: 8px; font-size: 16px;">
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="confirmExport" class="search-button" style="max-width: 200px;">
                    <i class="fas fa-check"></i> Confirm Export
                </button>
            </div>
        </div>
    </div>
</div>

    <div id="exportConfirmationModal" class="contact-modal">
    <div class="modal-content" style="border-left: 4px solid #AAF0D1;">
        <span class="close-export-confirmation-modal">&times;</span>
        
        <div class="modal-header" style="border-bottom-color: #AAF0D1;">
            <h2 class="modal-title"><i class="fas fa-check-circle" style="color: #2a6;"></i> Export Request Confirmed</h2>
        </div>
        
        <div class="modal-body">
            <div class="info-item" style="text-align: center;">
                <div class="info-value">
                    <p style="font-size: 18px; margin-bottom: 15px;"><strong>Your export has been processed successfully!</strong></p>
                    <p>The contact list will be delivered to your email within the next 3 hours.</p>
                    <p style="color: #2a6; margin-top: 15px;"><i class="fas fa-envelope"></i> Please check your inbox and spam folder.</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button id="closeConfirmationBtn" class="search-button" style="max-width: 200px; background-color: #2a6;">
                    <i class="fas fa-thumbs-up"></i> Got it
                </button>
            </div>
        </div>
    </div>
</div>
    
    <script>
        // n8n webhook URL
        const N8N_WEBHOOK_URL = 'https://eliasse-n8n.onrender.com/webhook/0b8401b5-8d6d-426d-a92e-1d94b2e3fab4';
        
        // Supabase details (needed for n8n to make the request)
        const SUPABASE_URL = 'https://snxhsboboatjywgwdeds.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueGhzYm9ib2F0anl3Z3dkZWRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwMTY5NzgsImV4cCI6MjA2MTU5Mjk3OH0.qkoiXJoqujQ4iUByOqSAsacuJVtJx32j19PTuy7brMo';
        
        // Global variables
        // Authentication variables
        let isAuthenticated = false;
        let currentUser = null;
        let allContacts = [];
        let globalTrueCount = 0;
        // DOM Elements
        const searchForm = document.getElementById('searchForm');
        const countrySelect = document.getElementById('country');
        const industrySelect = document.getElementById('industry');
        const searchAlert = document.getElementById('searchAlert');
        const loading = document.getElementById('loading');
        const resultsSection = document.getElementById('resultsSection');
        const resultsNumber = document.getElementById('resultsNumber');
        const resultsBody = document.getElementById('resultsBody');
        const noResults = document.getElementById('noResults');
        const resultsTable = document.getElementById('resultsTable');
        const exportButton = document.getElementById('exportButton');
        const contactModal = document.getElementById('contactModal');
        const closeModal = document.querySelector('.close-modal');
        const startRecord = document.getElementById('startRecord');
        const endRecord = document.getElementById('endRecord');
        const totalDisplayRecords = document.getElementById('totalDisplayRecords');
        
// Initialize the app
document.addEventListener('DOMContentLoaded', async () => {
    // First check if user is authenticated
    const isLoggedIn = checkAuth();
    
    // Set up auth event listeners (do this regardless of login state)
    document.getElementById('loginButton').addEventListener('click', loginUser);
    document.getElementById('registerButton').addEventListener('click', registerUser);
    document.getElementById('showLoginLink').addEventListener('click', (e) => {
        e.preventDefault();
        showAuthForm('loginForm');
    });
    document.getElementById('showRegisterLink').addEventListener('click', (e) => {
        e.preventDefault();
        showAuthForm('registerForm');
    });
    document.getElementById('logoutButton').addEventListener('click', logout);
    
    if (!isLoggedIn) {
        // If not logged in, just exit - don't load the main app data
        return;
    }
    
    // If logged in, continue with normal app initialization
    // Show loading indicator
    loading.style.display = 'block';
    
    try {
        // Fetch initial data from Supabase via n8n
        await fetchData();

        globalTrueCount = await fetchTotalCount();
        
        // Display data immediately
        displayInitialResults();
        
        // Populate dropdowns
        populateCountryDropdown();
        populateIndustryDropdown();
        
        // Set up event listeners
        searchForm.addEventListener('submit', handleSearch);
        exportButton.addEventListener('click', exportToCSV);
        closeModal.addEventListener('click', () => {
            contactModal.style.display = 'none';
        });
        
        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === contactModal) {
                contactModal.style.display = 'none';
            }
        });
        
        // Show success message
        showAlert("Connected to database successfully! Ready to search.", 'success');
    } catch (error) {
        console.error("Error initializing app:", error);
        showAlert(`Error connecting to database: ${error.message}`, 'error');
    } finally {
        // Hide loading indicator
        loading.style.display = 'none';
    }
});
        
        // Fetch data from Supabase via n8n webhook
        async function fetchData() {
            try {
                // Show loading indicator
                loading.style.display = 'block';
                
                // Prepare the data to send to n8n
                const requestData = {
                    action: 'fetchAll',
                    supabaseUrl: SUPABASE_URL,
                    supabaseKey: SUPABASE_KEY,
                    tableName: 'unlimited',  // Changed to new table name
                    limit: 1000
                };
                
                // Make POST request to n8n webhook
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Validate that data is an array
                if (!Array.isArray(data)) {
                    console.error('Response is not an array:', data);
                    throw new Error('Expected array response from API');
                }
                
                console.log(`Received ${data.length} contacts from API`);
                
                // Store the data directly
                allContacts = data;
                
            } catch (error) {
                console.error("Error fetching data:", error);
                throw error;
            }
        }

        
        
        // Populate country dropdown
        function populateCountryDropdown() {
            // Extract unique countries
            const countries = [...new Set(allContacts.map(contact => contact.country).filter(Boolean).sort())];
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        
        // Populate industry dropdown
        function populateIndustryDropdown() {
            // Extract unique industries
            const industries = [...new Set(allContacts.map(contact => contact.industry).filter(Boolean).sort())];
            
            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industrySelect.appendChild(option);
            });
        }
        
       // Correction de la fonction displayInitialResults pour afficher correctement les données
function displayInitialResults() {
    // Show results section
    resultsSection.style.display = 'block';
    
    // Clear existing results
    resultsBody.innerHTML = '';
    
    // Show or hide no results message - don't calculate count here
    if (allContacts.length === 0) {
        noResults.style.display = 'block';
        resultsTable.style.display = 'none';
        startRecord.textContent = '0';
        endRecord.textContent = '0';
        // Don't update count displays here - let fetchTotalCount handle this
        return;
    } else {
        noResults.style.display = 'none';
        resultsTable.style.display = 'table';
    }
    
    // Display only the first 25 contacts
    const displayContacts = allContacts.slice(0, 25);
    
    // Update pagination info for records shown, but NOT the count
    startRecord.textContent = '1';
    endRecord.textContent = displayContacts.length;
    // Don't update totalDisplayRecords here - let fetchTotalCount do it
    
    // Populate the table with contacts
    displayContacts.forEach(contact => {
        const row = document.createElement('tr');
        
        // D'après votre échantillon de données, les noms des colonnes sont "first name", "last name", "title", "company"
        // (au lieu de "job title" et "company name")
        row.innerHTML = `
            <td>${contact['first name'] || ''} ${contact['last name'] || ''}</td>
            <td>${contact['title'] || 'N/A'}</td>
            <td>${contact['company'] || 'N/A'}</td>
            <td>${contact['email'] || 'N/A'}</td>
            <td>${contact['country'] || 'N/A'}</td>
            <td>
                <div class="action-icons">
                    <i class="fas fa-eye" title="View Details"></i>
                    <i class="fas fa-save" title="Save Contact"></i>
                </div>
            </td>
        `;
        
        // Add event listener to view contact details
        row.querySelector('.fa-eye').addEventListener('click', () => {
            showContactDetails(contact);
        });
        
        resultsBody.appendChild(row);
    });
}

// Correction de la fonction showContactDetails pour afficher correctement les données
function showContactDetails(contact) {
    // Fill in modal details
    document.getElementById('modalName').textContent = `${contact['first name'] || ''} ${contact['last name'] || ''}`;
    document.getElementById('modalFullName').textContent = `${contact['first name'] || ''} ${contact['last name'] || ''}`;
    document.getElementById('modalTitle').textContent = contact['title'] || 'N/A';
    document.getElementById('modalManagementLevel').textContent = contact['managementlevel'] || 'N/A';
    document.getElementById('modalEmail').textContent = contact['email'] || 'N/A';
    document.getElementById('modalPhone').textContent = contact['phone'] || 'N/A';
    document.getElementById('modalLinkedIn').textContent = contact['linkedin'] || 'N/A';
    document.getElementById('modalLocation').textContent = contact['city'] || contact['country'] || 'N/A';
    
    document.getElementById('modalCompany').textContent = contact['company'] || 'N/A';
    document.getElementById('modalIndustry').textContent = contact['industry'] || 'N/A';
    document.getElementById('modalCompanySize').textContent = contact['companysize'] || 'N/A';
    document.getElementById('modalWebsite').textContent = contact['website'] || 'N/A';
    document.getElementById('modalCompanyPhone').textContent = contact['cphone'] || 'N/A';
    document.getElementById('modalDescription').textContent = contact['description'] || 'N/A';
    
    // Show the modal
    contactModal.style.display = 'block';
}

// Également, il faut modifier la fonction handleSearch pour utiliser les bons noms de colonnes
async function handleSearch(e) {
    e.preventDefault();
    
    // Show loading indicator
    loading.style.display = 'block';
    resultsSection.style.display = 'none';
    searchAlert.style.display = 'none';
    
    try {
        // Get form values
        const country = countrySelect.value;
        const industry = industrySelect.value;
        const managementLevel = document.getElementById('managementLevel').value;
        const companyName = document.getElementById('companyName').value;
        const keywords = document.getElementById('keywords').value;
        
        // If search criteria are provided, filter the data
        if (country || industry || managementLevel || companyName || keywords) {
            try {
                // Search contacts using n8n webhook
                const requestData = {
                    action: 'search',
                    supabaseUrl: SUPABASE_URL,
                    supabaseKey: SUPABASE_KEY,
                    tableName: 'unlimited',
                    searchParams: {
                        country,
                        industry,
                        managementlevel: managementLevel,
                        // Utiliser le nom correct pour le champ company name
                        company: companyName,  // Au lieu de companyName
                        keywords
                    },
                    limit: 1000
                };
                
                // Make POST request to n8n webhook
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update allContacts with search results
                allContacts = data;

                    // ► NEW: fetch the true total count
    const trueCount = await fetchTotalCount();
    // update your UI with the count from the RPC
    resultsNumber.textContent        = trueCount;
    totalDisplayRecords.textContent  = trueCount;
    startRecord.textContent          = trueCount > 0 ? '1' : '0';
    endRecord.textContent            = trueCount > 0
                                        ? Math.min(25, trueCount)
                                        : '0';

                
                // Show search completion message
                    showAlert(`Search completed: Found ${trueCount} contacts.`, 'success');
            } catch (error) {
                showAlert(`Error searching: ${error.message}`, 'error');
            }
        }
        
        // Display the results (either original or filtered)
        displayInitialResults();
        
    } catch (error) {
        console.error("Error handling search:", error);
        showAlert(`Error: ${error.message}`, 'error');
    } finally {
        // Hide loading indicator
        loading.style.display = 'none';
        resultsSection.style.display = 'block';
    }
}

async function exportToCSV() {
    try {
        // Show the custom export modal
        const exportModal = document.getElementById('exportModal');
        exportModal.style.display = 'block';
        
        // Add event listener for the close button
        const closeExportModal = document.querySelector('.close-export-modal');
        closeExportModal.addEventListener('click', () => {
            exportModal.style.display = 'none';
        });
        
        // Add event listener for the confirm button
        const confirmExportBtn = document.getElementById('confirmExport');
        confirmExportBtn.addEventListener('click', async () => {
            // Hide the export modal
            exportModal.style.display = 'none';
            
            // Get the export limit from the input field
            const exportLimit = parseInt(document.getElementById('exportLimit').value) || 1000;
            
            // Show loading screen while making the API call
            loading.style.display = 'block';
            
            try {
                // Make a specific API call to get all data for export
                const requestData = {
                    action: 'export',
                    supabaseUrl: SUPABASE_URL,
                    supabaseKey: SUPABASE_KEY,
                    tableName: 'unlimited',
                    // Add the export limit to the request
                    limit: exportLimit,
                    // Pass any active filters from the search form
                    searchParams: {
    country: countrySelect.value,
    industry: industrySelect.value,
    managementlevel: document.getElementById('managementLevel').value,
    company: document.getElementById('companyName').value,
    keywords: document.getElementById('keywords').value
}
                };
                
                // Make POST request to n8n webhook
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                // Hide loading screen
                loading.style.display = 'none';
                
                // Show the confirmation modal (more visible than just an alert)
                const confirmationModal = document.getElementById('exportConfirmationModal');
                confirmationModal.style.display = 'block';
                
                // Set up close button for confirmation modal
                const closeConfirmBtn = document.querySelector('.close-export-confirmation-modal');
                closeConfirmBtn.addEventListener('click', () => {
                    confirmationModal.style.display = 'none';
                });
                
                // Set up "Got it" button
                const closeConfirmationBtn = document.getElementById('closeConfirmationBtn');
                closeConfirmationBtn.addEventListener('click', () => {
                    confirmationModal.style.display = 'none';
                });
                
                // Close modal when clicking outside of it
                window.addEventListener('click', (event) => {
                    if (event.target === confirmationModal) {
                        confirmationModal.style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('Error processing export:', error);
                loading.style.display = 'none';
                showAlert(`Error: ${error.message}`, 'error');
            }
            
            // Remove the event listener to prevent multiple attachments
            confirmExportBtn.removeEventListener('click', arguments.callee);
        });
        
        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === exportModal) {
                exportModal.style.display = 'none';
            }
        });
        
    } catch (error) {
        console.error('Error initiating export process:', error);
        showAlert(`Error: ${error.message}`, 'error');
        loading.style.display = 'none';
    }
}
 // Get the total count of contacts without fetching all data
async function fetchTotalCount() {
  try {
    const requestData = {
      action: 'getCount',
      supabaseUrl: SUPABASE_URL,
      supabaseKey: SUPABASE_KEY,
      tableName: 'unlimited',
      searchParams: {
        country: countrySelect.value,
        industry: industrySelect.value,
        managementlevel: document.getElementById('managementLevel').value,
        company: document.getElementById('companyName').value,
        keywords: document.getElementById('keywords').value
      }
    };
    const response = await fetch(N8N_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    });
    if (!response.ok) throw new Error(`API error: ${response.status}`);
    const data = await response.json();
    // data is [count], so grab first element
    const trueCount = Array.isArray(data) && typeof data[0] === 'number' ? data[0] : 0;
    resultsNumber.textContent       = trueCount;
    totalDisplayRecords.textContent = trueCount;
    return trueCount;
  } catch (err) {
    console.error('Error fetching count:', err);
    return 0;
  }
}
        // Authentication Functions
function showAuthForm(formId) {
    const authForms = document.querySelectorAll('.auth-form');
    authForms.forEach(form => form.classList.add('hidden'));
    document.getElementById(formId).classList.remove('hidden');
}

function showAuthAlert(elementId, message, type) {
    const alertElement = document.getElementById(elementId);
    alertElement.textContent = message;
    alertElement.className = `alert alert-${type}`;
    alertElement.style.display = 'block';
    
    // Hide the alert after 5 seconds
    setTimeout(() => {
        alertElement.style.display = 'none';
    }, 5000);
}

async function registerUser() {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    // Basic validation
    if (!email || !password) {
        showAuthAlert('registerAlert', 'Please enter both email and password.', 'error');
        return;
    }
    
    // Email format validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showAuthAlert('registerAlert', 'Please enter a valid email address.', 'error');
        return;
    }
    
    // Password validation
    if (password.length < 8) {
        showAuthAlert('registerAlert', 'Password must be at least 8 characters long.', 'error');
        return;
    }
    
    try {
        // Show loading state
        const registerButton = document.getElementById('registerButton');
        registerButton.disabled = true;
        registerButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
        
        // Send registration data to webhook
        const response = await fetch('https://eliasse-n8n.onrender.com/webhook/c56a0557-0e55-450d-a2b4-52e476de88c3', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'register',
                email: email,
                password: password
            })
        });
        
        // Reset button state
        registerButton.disabled = false;
        registerButton.innerHTML = '<i class="fas fa-user-plus"></i> Register';
        
        if (!response.ok) {
            throw new Error('Registration failed. Please try again.');
        }
        
        // Show success message
        showAuthAlert('registerAlert', 'Registration successful! Please check your email to verify your account.', 'success');
        
        // Switch to login form after delay
        setTimeout(() => {
            showAuthForm('loginForm');
            showAuthAlert('authAlert', 'Please login with your new account.', 'success');
        }, 2000);
    } catch (error) {
        console.error('Registration error:', error);
        showAuthAlert('registerAlert', error.message || 'Registration failed. Please try again.', 'error');
    }
}

async function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    // Basic validation
    if (!email || !password) {
        showAuthAlert('authAlert', 'Please enter both email and password.', 'error');
        return;
    }
    
    try {
        // Show loading state
        const loginButton = document.getElementById('loginButton');
        loginButton.disabled = true;
        loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        
        // Send login data to webhook
        const response = await fetch('https://eliasse-n8n.onrender.com/webhook/c56a0557-0e55-450d-a2b4-52e476de88c3', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'login',
                email: email,
                password: password
            })
        });
        
        // Reset button state
        loginButton.disabled = false;
        loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        
        if (!response.ok) {
            throw new Error('Invalid email or password.');
        }
        
        // Parse response
        const data = await response.json();
        
        // Store auth token and user info in localStorage for persistence
        // Set expiration of 7 days (or however long you want users to stay logged in)
        const expirationTime = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 days in milliseconds
        
        const authData = {
            token: data.token || 'demo-token-' + Date.now(),
            email: email,
            expiresAt: expirationTime
        };
        
        localStorage.setItem('authData', JSON.stringify(authData));
        
        // Update UI to show user is logged in
        setAuthenticatedState(true, email);
        
        // Show success message
        showAlert('Login successful! You can now search for business contacts.', 'success');
    } catch (error) {
        console.error('Login error:', error);
        showAuthAlert('authAlert', error.message || 'Login failed. Please try again.', 'error');
    }
}

function logout() {
    // Clear auth data
    localStorage.removeItem('authData');
    
    // Update UI
    setAuthenticatedState(false);
    
    // Show message
    showAuthAlert('authAlert', 'You have been logged out.', 'success');
}

function setAuthenticatedState(isLoggedIn, email = null) {
    isAuthenticated = isLoggedIn;
    currentUser = email;
    
    // Show/hide appropriate containers
    const appContent = document.querySelectorAll('.search-section, .results-section');
    const authContainer = document.getElementById('authContainer');
    const userInfo = document.getElementById('userInfo');
    
    if (isLoggedIn) {
        // Show app content and user info
        appContent.forEach(section => section.style.display = 'block');
        authContainer.style.display = 'none';
        userInfo.classList.remove('hidden');
        
        // Display user email
        document.getElementById('userEmailDisplay').textContent = email;
    } else {
        // Hide app content and show login
        appContent.forEach(section => section.style.display = 'none');
        resultsSection.style.display = 'none';
        authContainer.style.display = 'block';
        userInfo.classList.add('hidden');
        showAuthForm('loginForm');
    }
}

function checkAuth() {
    const authDataString = localStorage.getItem('authData');
    
    if (!authDataString) {
        // No auth data found
        setAuthenticatedState(false);
        return false;
    }
    
    try {
        const authData = JSON.parse(authDataString);
        const { token, email, expiresAt } = authData;
        
        // Check if the token has expired
        if (Date.now() > expiresAt) {
            // Token has expired, log the user out
            console.log('Auth token expired, logging out');
            localStorage.removeItem('authData');
            setAuthenticatedState(false);
            return false;
        }
        
        // Valid token and not expired
        setAuthenticatedState(true, email);
        
        // Refresh the expiration time to keep the user logged in
        // This extends their session with each new visit
        const newExpirationTime = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 days in milliseconds
        const updatedAuthData = {
            ...authData,
            expiresAt: newExpirationTime
        };
        localStorage.setItem('authData', JSON.stringify(updatedAuthData));
        
        return true;
    } catch (error) {
        console.error('Error checking auth:', error);
        setAuthenticatedState(false);
        return false;
    }
}

        // Helper function to show alerts
        function showAlert(message, type) {
            searchAlert.textContent = message;
            searchAlert.className = `alert alert-${type}`;
            searchAlert.style.display = 'block';
            
            // Hide the alert after 5 seconds
            setTimeout(() => {
                searchAlert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
